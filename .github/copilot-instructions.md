## Цель
Краткие, практичные указания для AI-агента, который правит этот репозиторий — телеграм‑бот для приёма и модерации музыкальных релизов.

## Большая картина
- Это одиночный процессный Telegram‑бот на `python-telegram-bot==21.5` (см. `requirements.txt`).
- Данные хранятся в простых JSON-файлах в корне репозитория: `releases.json`, `moderation_releases.json`, `drafts.json`, `history.json`.
- Поток: пользователь отправляет анкету → сохраняется в `releases.json` → модерация записывает в `moderation_releases.json` и обновляет статус в `releases.json`.

## Ключевые файлы и точки интеграции
- `main.py` — весь основной код: обработчики, валидация, атомарная запись в файлы.
- `requirements.txt` — единственная зависимость: `python-telegram-bot==21.5`.
- `releases.json`, `moderation_releases.json` — примеры структуры данных; читай их перед изменениями.

## Важные проектные паттерны (примеры из кода)
- Атомарная запись JSON: используйте `_atomic_write_json(path, obj)` для сохранения файлов (временный файл + `os.replace`). Не менять формат хранения.
- Безопасная отправка/редактирование сообщений: используйте `safe_send`, `safe_edit`, `safe_edit_reply_markup` — они реализуют ретраи и обход ошибок протокола httpx.
- Проверка ссылок: `_looks_like_url`, `_looks_like_drive_link`, `_looks_like_yandex_music_link` — пользуйтесь ими при валидации полей `link`/`yandex`.
- Приведение `user_id` к `int` в `is_admin()` — ожидается, что ID могут быть строками.

## Режим разработки и запуск
- Установить зависимости:
  ```bash
  pip install -r requirements.txt
  ```
- Запуск бота (локально):
  ```bash
  set BOT_TOKEN=<token>   # Windows PowerShell: $env:BOT_TOKEN = '...'
  python main.py
  ```
- Токен по умолчанию в `main.py` — временный/примерный; не коммитить реальные токены.

## Правила при изменениях данных
- При изменении формата данных обновляйте и примеры в `releases.json`/`moderation_releases.json` и убедитесь, что `_load_json_or_default` корректно обрабатывает старые записи.
- Не производите прямую запись в JSON через `open(...,'w')` — всегда `_atomic_write_json`.

## Конвенции кода
- Комментарии и тексты на русском — пиши дополнения на русском.
- Логирование идёт через `print()` в коде — при необходимости добавляй минимальные сообщения для отладки, но не ломай существующие тексты сообщений пользователю.

## Отладка и распространённые ошибки
- Частые проблемы: `httpx.RemoteProtocolError` — не крашить процесс, использовать существующие защитные обёртки (`_is_remote_protocol_error`, `safe_*`).
- При «пропадающих» релизах причина обычно в неатомарной записи — проверяй `_atomic_write_json` и права записи в файловой системе.

## Что ожидать от агента
- Делай минимальные, целевые правки: обновление обработчиков, валидации, форматирования JSON.
- При изменениях формата данных: добавь миграцию/скрипт или защитный код чтения (backwards-compatible). Приводи примеры изменений рядом с `releases.json`.

Если что-то непонятно в структуре данных или поведении бота — скажи, какие части кода нужно пояснить, и я добавлю примеры/фрагменты.
